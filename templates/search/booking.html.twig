{% extends 'base.html.twig' %}
{% block body %}

	<div class="user-contain px-28 py-5 bg bg-slate-100">
		<div class="header-user flex justify-evenly">
			<div class="pic_profil">
				<img src="{{ hall.logo }}" alt="" class="user-img">
			</div>
			<div class="user-infos">
				<h3 class="font-bold ">{{ hall.name }}
					({{hall.structure}})</h3>
				<p>{{ hall.hallInfo.country }}</p>
				<p>{{ hall.hallInfo.zipCode }},
					{{ hall.hallInfo.city }}</p>
				<p>{{ hall.hallInfo.email }}</p>
				<p>{{ hall.hallInfo.phone }}</p>
				<div class="flex">
					{% for musicCategory in hall.musicCategory %}
						<p>{{ musicCategory.category }}
							,
						</p>
					{% endfor %}

				</div>
				{# {% for event in hall.events %}
										<p>{{event.date|date('l j F Y')}}</p>
									{% endfor %} #}
			</div>

		</div>
		<div class="tab_project">
			<div class="my-10">
				<div class="flex-responsive ">

					<div class=" calendar bg-slate-700  text-white p-5 rounded-md lg:mr-3 mb-3 lg:mb-0">
						<div class="flex justify-between">
							<button id="prevMonth" class="arrow-left text-white rounded-full bg-slate-500 font-bold  px-2 mx-1">&#10094;</button>
							<div id="monthYearHeader"></div>
							<button id="nextMonth" class="arrow-right text-white rounded-full bg-slate-500 font-bold  px-2 mx-1">&#10095;</button>
						</div>
						<div id="calendrier"></div>
						{# <div id="calendar-holder"></div> #}
					</div>

					<div class="event-list-db bg-white rounded-md shadow-md w-full ">
						<h4 class="bg-slate-700 text-white p-2 rounded-t-md">Historique de mes évènements
						</h4>
						<div class="p-3 w-flex">


							<form action="{{ path('app_search_booking', {'id': hall.id}) }}" method="post">
								<label for="booking_date" class='text-blue-400 font-semibold'>Date Sélectionné :
									<span id="eventCountDisplay"></span>
								</label><br>
								<input type="text" id="booking_date" name="booking_date" value="{{ date|date('d-m-Y') }}" required readonly>
								<br>

								<label for="band_id" class='text-blue-400 font-semibold'>Pour quel projet souhaitez-vous réserver ?</label><br>
								<select name="band_id" required >
									{% set displayedBands = [] %}

									{% for bandMember in app.user.profil.bandMembers %}
										{% set musicCategory = bandMember.band.musicCategory.category %}
										{% set isMusicAccepted = hall.musicCategory|filter(category => category.category == musicCategory)|length > 0 %}
										{% set bandName = bandMember.band.name %}
										{% if bandName not in displayedBands %}

											<option value="{{ bandMember.band.id }}" {% if not isMusicAccepted %} disabled {% endif %}>
												{{ bandMember.band.name }}
												({{ musicCategory }})

												{% if not isMusicAccepted %}
													(Genre musical non acceptée)
												{% endif %}

											</option>
											{% set displayedBands = displayedBands|merge([bandName]) %}
										{% endif %}
									{% endfor %}
								</select><br>
								<button type="submit" class="btnFormAccess">Réserver</button>
							</form>

						</div>
					</div>
				</div>
			</div>
			<div class="my-10">
				<h4>Membres</h4>
				<div class="bg-white rounded-lg shadow-md p-3">


					<a href="{{ path('app_hall_member_new') }}" class="text-slate-400 hover:text-blue-500 ">
						<button class="bg-slate-700 rounded-full px-2 pb-1 mr-4 text-white font-bold hover:bg-blue-500">+</button>Inviter un Groupe</a>
				</div>

			</div>
		</div>

	</div>


	<script>
		const events = [
{% for event in eventCome %}
{
date: '{{ event.date|date('Y-m-d') }}',
statusDate: '{{ event.status }}'
},{% endfor %}
// Ajoutez d'autres événements au besoin
];
console.log(events)
document.addEventListener('DOMContentLoaded', function () {
const calendar = document.getElementById('calendrier');
const prevMonthButton = document.getElementById('prevMonth');
const nextMonthButton = document.getElementById('nextMonth');
const bookingDateInput = document.getElementById('booking_date');

let currentDate = new Date();

// Replace this with logic to fetch events from your Symfony backend


// Function to render the calendar
function renderCalendar() {
const currentMonth = currentDate.getMonth();
const currentYear = currentDate.getFullYear();
const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();


// Update month and year header
monthYearHeader.textContent = `${
getMonthName(currentMonth)
} ${currentYear}`;

// Clear previous content
calendar.innerHTML = '';

// Create header row with day names
const dayNames = [
'Lun',
'Mar',
'Mer',
'Jeu',
'Ven',
'Sam',
'Dim'
]; // L'ordre commence par le lundi
dayNames.forEach(day => {
const dayHeader = document.createElement('div');
dayHeader.className = 'day';
dayHeader.textContent = day;
calendar.appendChild(dayHeader);
});

// Create days of the month
const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
const daysInPreviousMonth = new Date(currentYear, currentMonth, 0).getDate();
const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

// Calculate the position of the first day in the grid
let startPosition = (firstDayOfMonth - 1 + 7) % 7;

// Fill in the days of the previous month
for (let day = daysInPreviousMonth - startPosition + 1; day <= daysInPreviousMonth; day++) {
const dayElement = document.createElement('div');
dayElement.className = 'day other-month-day'; // Add a class to style differently
dayElement.textContent = day;
calendar.appendChild(dayElement);
}

// Reset startPosition for the days of the current month
startPosition = 0;

for (let day = 1; day <= daysInMonth; day++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'day current-month-day';
    dayElement.classList.add('valide-day');
    dayElement.textContent = day;

    // Ajoutez une condition pour vérifier si le jour est dans le passé
    if (new Date(currentYear, currentMonth, day) < new Date()) {
        dayElement.classList.add('other-month-day');
        dayElement.classList.remove('valide-day');
    } else {
        const currentDate = new Date();
        if (day === currentDate.getDate() && currentMonth === currentDate.getMonth() && currentYear === currentDate.getFullYear()) {
            dayElement.classList.add('current-day'); // Add a class for the current day
        }

        // Check if there are events on this day
        const eventsOnDay = events.filter(event => {
            const eventDate = new Date(event.date);
            return eventDate.getDate() === day && eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear;
        });

        // Process events based on statusDate
        const eventWithStatus1 = eventsOnDay.find(event => event.statusDate === '1');
        const eventWithStatus2 = eventsOnDay.find(event => event.statusDate === '2');
        const eventWithStatus3 = eventsOnDay.filter(event => event.statusDate === '3'); // Utiliser filter pour obtenir tous les événements avec le statut 3

        if (eventWithStatus1) {
            dayElement.classList.remove('valide-day');
            dayElement.classList.add('event-reserved');
        } else if (eventWithStatus3.length > 0) {
            dayElement.classList.remove('valide-day');
            dayElement.classList.add('in-progress');
            addClickEventListener(dayElement, day, currentMonth, currentYear, eventWithStatus3.length);
        } else {
            addClickEventListener(dayElement, day, currentMonth, currentYear, 0);
        }
    }

    calendar.appendChild(dayElement);
}

function addClickEventListener(element, day, month, year, eventCount) {
element.addEventListener('click', () => {
const formattedDate = `${day.toString().padStart(2, '0')}-${(month + 1).toString().padStart(2, '0')}-${year}`;
document.getElementById('booking_date').value = formattedDate;

// Afficher le nombre d'événements avec le statut 3 au-dessus du formulaire
const eventCountDisplay = document.getElementById('eventCountDisplay');
if (eventCountDisplay) {
if (eventCount == 0) {
eventCountDisplay.innerHTML = `<span class=" text-green-500">Libre</span>`;
} else {
const demandeText = eventCount === 1 ? 'Demande' : 'Demandes';
eventCountDisplay.innerHTML = `<span class="text-red-500">${eventCount} ${demandeText} en cours</span>`;
}
}
});
}

// Fill in the remaining days of the grid with the next month
const remainingDays = 35 - startPosition - daysInMonth; // 42 is the maximum number of days in a grid
for (let day = 1; day <= remainingDays; day++) {
const dayElement = document.createElement('div');
dayElement.className = 'day other-month-day'; // Add a class to style differently
dayElement.textContent = day;
calendar.appendChild(dayElement);
}
}

// Helper function to get month name
function getMonthName(month) {
const monthNames = [
'Janvier',
'Février',
'Mars',
'Avril',
'Mai',
'Juin',
'Juillet',
'Août',
'Septembre',
'Octobre',
'Novembre',
'Décembre'
];
return monthNames[month];
}

// Event listeners for navigation buttons
prevMonthButton.addEventListener('click', function () {
currentDate.setMonth(currentDate.getMonth() - 1);
renderCalendar();
});

nextMonthButton.addEventListener('click', function () {
currentDate.setMonth(currentDate.getMonth() + 1);
renderCalendar();
});

// Initial render
renderCalendar();
});


function formatDate(date) {
const options = {
weekday: 'long',
day: 'numeric',
month: 'long',
year: 'numeric'
};
const formattedDate = new Date(date).toLocaleDateString('fr-FR', options);
return formattedDate;
}
	</script>
{% endblock %}
